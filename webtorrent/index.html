<!DOCTYPE html>
<html>
	<head>
		<meta charset="uft-8"/>
		<title>Webtorrent & Gun</title>
	</head>
	<body>
		<ul>
		</ul>
		<input placeholder="Magnet link to add."><button class="submit">Submit</button>
		<button id="clear">
			Clear
		</button>
		<div class="infos">
			<p class="name"></p>
			<p class="progress"></p>
			<p class="howmuch"></p>
		</div>
		<div id="output">
		</div>
		
		<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js">
		</script>
		<script>
			var gun = Gun();
			
			let client;
			if (WebTorrent.WEBRTC_SUPPORT) {
  			// WebRTC is supported
				client = new WebTorrent();
			} else {
  			// Use a fallback
				alert('Not available.')
			}
			
			$(document).ready(function(){
  			$(".submit").click(function(){
					var toAdd = $('input').val();
					
					gun.get('lists').set(toAdd);
					
					$('input').val('');
  			});
				
				$('#clear').click(function() {
					window.localStorage.clear();
				})
				
				let data_fetched = "";
				gun.get('lists').map().on(function(data, key) {
					data_fetched = data;
					$('ul').append('<li id="' + key + '"><a class="link" href=' + data + '"' + '>' + data + '</a><button class="load">Load</button></li>');
				
				})

				$(document).on('click', '.load', function () {
					let magnet = $(this).parent().text().trim();
					alert(magnet)
					client.add(magnet, function(torrent) {
						
						// $('.remaining').text(moment.duration(torrent.timeRemaining / 1000, 'seconds'))
						
						$('.name').text("The torrent I'm going to load is : " + torrent.name + " !");
        		
						setInterval(onProgress, 500)
						onProgress();
						
						function onProgress() {
							var percent = Math.round(torrent.progress * 100 * 100) / 100
							$('.progress').text(percent + '%');
							$('.howmuch').text(prettyBytes(torrent.downloadSpeed) + '/s')
						}
						
						var file = torrent.files.find(function (file) {
								return file.name.endsWith('.mp4')
	 					})
						
						function prettyBytes(num) {
							var exponent, unit, neg = num < 0, units = ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
  						if (neg) num = -num
        			if (num < 1) return (neg ? '-' : '') + num + ' B'
        			
							exponent = Math.min(Math.floor(Math.log(num) / Math.log(1000)), units.length - 1)
       	 			num = Number((num / Math.pow(1000, exponent)).toFixed(2))
        			unit = units[exponent]
        			return (neg ? '-' : '') + num + ' ' + unit
      			}
						
						file.appendTo('#output')
					})
				})
				
			});
			
		</script>
	</body>
</html>
